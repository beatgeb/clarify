(function(a){'use strict';if(typeof define==='function'&&define.amd){define(['jquery','jquery.ui.widget'],a)}else{a(window.jQuery)}}(function($){'use strict';$.support.xhrFileUpload=!!(window.XMLHttpRequestUpload&&window.FileReader);$.support.xhrFormDataFileUpload=!!window.FormData;$.widget('blueimp.fileupload',{options:{dropZone:$(document),pasteZone:$(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,limitMultiFileUploads:undefined,sequentialUploads:false,limitConcurrentUploads:undefined,forceIframeTransport:false,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,progressInterval:100,bitrateInterval:500,formData:function(a){return a.serializeArray()},add:function(e,a){a.submit()},processData:false,contentType:false,cache:false},_refreshOptionsList:['fileInput','dropZone','pasteZone','multipart','forceIframeTransport'],_BitrateTimer:function(){this.timestamp=+(new Date());this.loaded=0;this.bitrate=0;this.getBitrate=function(a,b,c){var d=a-this.timestamp;if(!this.bitrate||!c||d>c){this.bitrate=(b-this.loaded)*(1000/d)*8;this.loaded=b;this.timestamp=a}return this.bitrate}},_isXHRUpload:function(a){return!a.forceIframeTransport&&((!a.multipart&&$.support.xhrFileUpload)||$.support.xhrFormDataFileUpload)},_getFormData:function(c){var d;if(typeof c.formData==='function'){return c.formData(c.form)}if($.isArray(c.formData)){return c.formData}if(c.formData){d=[];$.each(c.formData,function(a,b){d.push({name:a,value:b})});return d}return[]},_getTotal:function(c){var d=0;$.each(c,function(a,b){d+=b.size||1});return d},_onProgress:function(e,a){if(e.lengthComputable){var b=+(new Date()),total,loaded;if(a._time&&a.progressInterval&&(b-a._time<a.progressInterval)&&e.loaded!==e.total){return}a._time=b;total=a.total||this._getTotal(a.files);loaded=parseInt(e.loaded/e.total*(a.chunkSize||total),10)+(a.uploadedBytes||0);this._loaded+=loaded-(a.loaded||a.uploadedBytes||0);a.lengthComputable=true;a.loaded=loaded;a.total=total;a.bitrate=a._bitrateTimer.getBitrate(b,loaded,a.bitrateInterval);this._trigger('progress',e,a);this._trigger('progressall',e,{lengthComputable:true,loaded:this._loaded,total:this._total,bitrate:this._bitrateTimer.getBitrate(b,this._loaded,a.bitrateInterval)})}},_initProgressListener:function(b){var c=this,xhr=b.xhr?b.xhr():$.ajaxSettings.xhr();if(xhr.upload){$(xhr.upload).bind('progress',function(e){var a=e.originalEvent;e.lengthComputable=a.lengthComputable;e.loaded=a.loaded;e.total=a.total;c._onProgress(e,b)});b.xhr=function(){return xhr}}},_initXHRData:function(c){var d,file=c.files[0],multipart=c.multipart||!$.support.xhrFileUpload,paramName=c.paramName[0];c.headers=c.headers||{};if(c.contentRange){c.headers['Content-Range']=c.contentRange}if(!multipart){c.headers['Content-Disposition']='attachment; filename="'+encodeURI(file.name)+'"';c.contentType=file.type;c.data=c.blob||file}else if($.support.xhrFormDataFileUpload){if(c.postMessage){d=this._getFormData(c);if(c.blob){d.push({name:paramName,value:c.blob})}else{$.each(c.files,function(a,b){d.push({name:c.paramName[a]||paramName,value:b})})}}else{if(c.formData instanceof FormData){d=c.formData}else{d=new FormData();$.each(this._getFormData(c),function(a,b){d.append(b.name,b.value)})}if(c.blob){c.headers['Content-Disposition']='attachment; filename="'+encodeURI(file.name)+'"';d.append(paramName,c.blob,file.name)}else{$.each(c.files,function(a,b){if((window.Blob&&b instanceof Blob)||(window.File&&b instanceof File)){d.append(c.paramName[a]||paramName,b,b.name)}})}}c.data=d}c.blob=null},_initIframeSettings:function(a){a.dataType='iframe '+(a.dataType||'');a.formData=this._getFormData(a);if(a.redirect&&$('<a></a>').prop('href',a.url).prop('host')!==location.host){a.formData.push({name:a.redirectParamName||'redirect',value:a.redirect})}},_initDataSettings:function(a){if(this._isXHRUpload(a)){if(!this._chunkedUpload(a,true)){if(!a.data){this._initXHRData(a)}this._initProgressListener(a)}if(a.postMessage){a.dataType='postmessage '+(a.dataType||'')}}else{this._initIframeSettings(a,'iframe')}},_getParamName:function(b){var c=$(b.fileInput),paramName=b.paramName;if(!paramName){paramName=[];c.each(function(){var a=$(this),name=a.prop('name')||'files[]',i=(a.prop('files')||[1]).length;while(i){paramName.push(name);i-=1}});if(!paramName.length){paramName=[c.prop('name')||'files[]']}}else if(!$.isArray(paramName)){paramName=[paramName]}return paramName},_initFormSettings:function(a){if(!a.form||!a.form.length){a.form=$(a.fileInput.prop('form'));if(!a.form.length){a.form=$(this.options.fileInput.prop('form'))}}a.paramName=this._getParamName(a);if(!a.url){a.url=a.form.prop('action')||location.href}a.type=(a.type||a.form.prop('method')||'').toUpperCase();if(a.type!=='POST'&&a.type!=='PUT'){a.type='POST'}if(!a.formAcceptCharset){a.formAcceptCharset=a.form.attr('accept-charset')}},_getAJAXSettings:function(a){var b=$.extend({},this.options,a);this._initFormSettings(b);this._initDataSettings(b);return b},_enhancePromise:function(a){a.success=a.done;a.error=a.fail;a.complete=a.always;return a},_getXHRPromise:function(a,b,c){var d=$.Deferred(),promise=d.promise();b=b||this.options.context||promise;if(a===true){d.resolveWith(b,c)}else if(a===false){d.rejectWith(b,c)}promise.abort=d.promise;return this._enhancePromise(promise)},_getUploadedBytes:function(a){var b=a.getResponseHeader('Range'),parts=b&&b.split('-'),upperBytesPos=parts&&parts.length>1&&parseInt(parts[1],10);return upperBytesPos&&upperBytesPos+1},_chunkedUpload:function(d,e){var f=this,file=d.files[0],fs=file.size,ub=d.uploadedBytes=d.uploadedBytes||0,mcs=d.maxChunkSize||fs,slice=file.slice||file.webkitSlice||file.mozSlice,dfd=$.Deferred(),promise=dfd.promise(),jqXHR,upload;if(!(this._isXHRUpload(d)&&slice&&(ub||mcs<fs))||d.data){return false}if(e){return true}if(ub>=fs){file.error='Uploaded bytes exceed file size';return this._getXHRPromise(false,d.context,[null,'error',file.error])}upload=function(i){var o=$.extend({},d);o.blob=slice.call(file,ub,ub+mcs,file.type);o.chunkSize=o.blob.size;o.contentRange='bytes '+ub+'-'+(ub+o.chunkSize-1)+'/'+fs;f._initXHRData(o);f._initProgressListener(o);jqXHR=($.ajax(o)||f._getXHRPromise(false,o.context)).done(function(a,b,c){ub=f._getUploadedBytes(c)||(ub+o.chunkSize);if(!o.loaded){f._onProgress($.Event('progress',{lengthComputable:true,loaded:ub-o.uploadedBytes,total:ub-o.uploadedBytes}),o)}d.uploadedBytes=o.uploadedBytes=ub;if(ub<fs){upload()}else{dfd.resolveWith(o.context,[a,b,c])}}).fail(function(a,b,c){dfd.rejectWith(o.context,[a,b,c])})};this._enhancePromise(promise);promise.abort=function(){return jqXHR.abort()};upload();return promise},_beforeSend:function(e,a){if(this._active===0){this._trigger('start');this._bitrateTimer=new this._BitrateTimer()}this._active+=1;this._loaded+=a.uploadedBytes||0;this._total+=this._getTotal(a.files)},_onDone:function(a,b,c,d){if(!this._isXHRUpload(d)){this._onProgress($.Event('progress',{lengthComputable:true,loaded:1,total:1}),d)}d.result=a;d.textStatus=b;d.jqXHR=c;this._trigger('done',null,d)},_onFail:function(a,b,c,d){d.jqXHR=a;d.textStatus=b;d.errorThrown=c;this._trigger('fail',null,d);if(d.recalculateProgress){this._loaded-=d.loaded||d.uploadedBytes||0;this._total-=d.total||this._getTotal(d.files)}},_onAlways:function(a,b,c,d){this._active-=1;d.textStatus=b;if(c&&c.always){d.jqXHR=c;d.result=a}else{d.jqXHR=a;d.errorThrown=c}this._trigger('always',null,d);if(this._active===0){this._trigger('stop');this._loaded=this._total=0;this._bitrateTimer=null}},_onSend:function(e,f){var g=this,jqXHR,aborted,slot,pipe,options=g._getAJAXSettings(f),send=function(){g._sending+=1;options._bitrateTimer=new g._BitrateTimer();jqXHR=jqXHR||(((aborted||g._trigger('send',e,options)===false)&&g._getXHRPromise(false,options.context,aborted))||g._chunkedUpload(options)||$.ajax(options)).done(function(a,b,c){g._onDone(a,b,c,options)}).fail(function(a,b,c){g._onFail(a,b,c,options)}).always(function(a,b,c){g._sending-=1;g._onAlways(a,b,c,options);if(options.limitConcurrentUploads&&options.limitConcurrentUploads>g._sending){var d=g._slots.shift(),isPending;while(d){isPending=d.state?d.state()==='pending':!d.isRejected();if(isPending){d.resolve();break}d=g._slots.shift()}}});return jqXHR};this._beforeSend(e,options);if(this.options.sequentialUploads||(this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending)){if(this.options.limitConcurrentUploads>1){slot=$.Deferred();this._slots.push(slot);pipe=slot.pipe(send)}else{pipe=(this._sequence=this._sequence.pipe(send,send))}pipe.abort=function(){aborted=[undefined,'abort','abort'];if(!jqXHR){if(slot){slot.rejectWith(options.context,aborted)}return send()}return jqXHR.abort()};return this._enhancePromise(pipe)}return send()},_onAdd:function(e,d){var f=this,result=true,options=$.extend({},this.options,d),limit=options.limitMultiFileUploads,paramName=this._getParamName(options),paramNameSet,paramNameSlice,fileSet,i;if(!(options.singleFileUploads||limit)||!this._isXHRUpload(options)){fileSet=[d.files];paramNameSet=[paramName]}else if(!options.singleFileUploads&&limit){fileSet=[];paramNameSet=[];for(i=0;i<d.files.length;i+=limit){fileSet.push(d.files.slice(i,i+limit));paramNameSlice=paramName.slice(i,i+limit);if(!paramNameSlice.length){paramNameSlice=paramName}paramNameSet.push(paramNameSlice)}}else{paramNameSet=paramName}d.originalFiles=d.files;$.each(fileSet||d.files,function(a,b){var c=$.extend({},d);c.files=fileSet?b:[b];c.paramName=paramNameSet[a];c.submit=function(){c.jqXHR=this.jqXHR=(f._trigger('submit',e,this)!==false)&&f._onSend(e,this);return this.jqXHR};result=f._trigger('add',e,c);return result});return result},_replaceFileInput:function(b){var c=b.clone(true);$('<form></form>').append(c)[0].reset();b.after(c).detach();$.cleanData(b.unbind('remove'));this.options.fileInput=this.options.fileInput.map(function(i,a){if(a===b[0]){return c[0]}return a});if(b[0]===this.element[0]){this.element=c}},_handleFileTreeEntry:function(c,d){var f=this,dfd=$.Deferred(),errorHandler=function(e){if(e&&!e.entry){e.entry=c}dfd.resolve([e])},dirReader;d=d||'';if(c.isFile){if(c._file){c._file.relativePath=d;dfd.resolve(c._file)}else{c.file(function(a){a.relativePath=d;dfd.resolve(a)},errorHandler)}}else if(c.isDirectory){dirReader=c.createReader();dirReader.readEntries(function(b){f._handleFileTreeEntries(b,d+c.name+'/').done(function(a){dfd.resolve(a)}).fail(errorHandler)},errorHandler)}else{dfd.resolve([])}return dfd.promise()},_handleFileTreeEntries:function(b,c){var d=this;return $.when.apply($,$.map(b,function(a){return d._handleFileTreeEntry(a,c)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(c){c=c||{};var d=c.items;if(d&&d.length&&(d[0].webkitGetAsEntry||d[0].getAsEntry)){return this._handleFileTreeEntries($.map(d,function(a){var b;if(a.webkitGetAsEntry){b=a.webkitGetAsEntry();if(b){b._file=a.getAsFile()}return b}return a.getAsEntry()}))}return $.Deferred().resolve($.makeArray(c.files)).promise()},_getSingleFileInputFiles:function(c){c=$(c);var d=c.prop('webkitEntries')||c.prop('entries'),files,value;if(d&&d.length){return this._handleFileTreeEntries(d)}files=$.makeArray(c.prop('files'));if(!files.length){value=c.prop('value');if(!value){return $.Deferred().resolve([]).promise()}files=[{name:value.replace(/^.*\\/,'')}]}else if(files[0].name===undefined&&files[0].fileName){$.each(files,function(a,b){b.name=b.fileName;b.size=b.fileSize})}return $.Deferred().resolve(files).promise()},_getFileInputFiles:function(a){if(!(a instanceof $)||a.length===1){return this._getSingleFileInputFiles(a)}return $.when.apply($,$.map(a,this._getSingleFileInputFiles)).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_onChange:function(e){var b=this,data={fileInput:$(e.target),form:$(e.target.form)};this._getFileInputFiles(data.fileInput).always(function(a){data.files=a;if(b.options.replaceFileInput){b._replaceFileInput(data.fileInput)}if(b._trigger('change',e,data)!==false){b._onAdd(e,data)}})},_onPaste:function(e){var d=e.originalEvent.clipboardData,items=(d&&d.items)||[],data={files:[]};$.each(items,function(a,b){var c=b.getAsFile&&b.getAsFile();if(c){data.files.push(c)}});if(this._trigger('paste',e,data)===false||this._onAdd(e,data)===false){return false}},_onDrop:function(e){var b=this,dataTransfer=e.dataTransfer=e.originalEvent.dataTransfer,data={};if(dataTransfer&&dataTransfer.files&&dataTransfer.files.length){e.preventDefault()}this._getDroppedFiles(dataTransfer).always(function(a){data.files=a;if(b._trigger('drop',e,data)!==false){b._onAdd(e,data)}})},_onDragOver:function(e){var a=e.dataTransfer=e.originalEvent.dataTransfer;if(this._trigger('dragover',e)===false){return false}if(a&&$.inArray('Files',a.types)!==-1){a.dropEffect='copy';e.preventDefault()}},_initEventHandlers:function(){if(this._isXHRUpload(this.options)){this._on(this.options.dropZone,{dragover:this._onDragOver,drop:this._onDrop});this._on(this.options.pasteZone,{paste:this._onPaste})}this._on(this.options.fileInput,{change:this._onChange})},_destroyEventHandlers:function(){this._off(this.options.dropZone,'dragover drop');this._off(this.options.pasteZone,'paste');this._off(this.options.fileInput,'change')},_setOption:function(a,b){var c=$.inArray(a,this._refreshOptionsList)!==-1;if(c){this._destroyEventHandlers()}this._super(a,b);if(c){this._initSpecialOptions();this._initEventHandlers()}},_initSpecialOptions:function(){var a=this.options;if(a.fileInput===undefined){a.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]')}else if(!(a.fileInput instanceof $)){a.fileInput=$(a.fileInput)}if(!(a.dropZone instanceof $)){a.dropZone=$(a.dropZone)}if(!(a.pasteZone instanceof $)){a.pasteZone=$(a.pasteZone)}},_create:function(){var a=this.options;$.extend(a,$(this.element[0].cloneNode(false)).data());this._initSpecialOptions();this._slots=[];this._sequence=this._getXHRPromise(true);this._sending=this._active=this._loaded=this._total=0;this._initEventHandlers()},_destroy:function(){this._destroyEventHandlers()},add:function(b){var c=this;if(!b||this.options.disabled){return}if(b.fileInput&&!b.files){this._getFileInputFiles(b.fileInput).always(function(a){b.files=a;c._onAdd(null,b)})}else{b.files=$.makeArray(b.files);this._onAdd(null,b)}},send:function(e){if(e&&!this.options.disabled){if(e.fileInput&&!e.files){var f=this,dfd=$.Deferred(),promise=dfd.promise(),jqXHR,aborted;promise.abort=function(){aborted=true;if(jqXHR){return jqXHR.abort()}dfd.reject(null,'abort','abort');return promise};this._getFileInputFiles(e.fileInput).always(function(d){if(aborted){return}e.files=d;jqXHR=f._onSend(null,e).then(function(a,b,c){dfd.resolve(a,b,c)},function(a,b,c){dfd.reject(a,b,c)})});return this._enhancePromise(promise)}e.files=$.makeArray(e.files);if(e.files.length){return this._onSend(null,e)}}return this._getXHRPromise(false,e&&e.context)}})}));